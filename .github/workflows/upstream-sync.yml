# SPDX-FileCopyrightText: 2026 shadPS4 Emulator Project
# SPDX-License-Identifier: GPL-2.0-or-later

name: Upstream Sync

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: upstream-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-24.04
    env:
      UPSTREAM_REPO: shadps4-emu/shadPS4
      UPSTREAM_BRANCH: main
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Cache git rerere
        uses: actions/cache@v4
        with:
          path: .git/rr-cache
          key: rerere-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            rerere-${{ runner.os }}-${{ github.ref_name }}-

      - name: Run upstream sync
        id: sync
        run: |
          chmod +x .github/scripts/upstream-sync.sh
          .github/scripts/upstream-sync.sh

      - name: Create conflict PR
        if: steps.sync.outputs.merge_result == 'conflict'
        uses: actions/github-script@v7
        env:
          SYNC_BRANCH: ${{ steps.sync.outputs.sync_branch }}
          UPSTREAM_REPO: ${{ env.UPSTREAM_REPO }}
          UPSTREAM_BRANCH: ${{ env.UPSTREAM_BRANCH }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const syncBranch = process.env.SYNC_BRANCH;
            if (!syncBranch) {
              core.setFailed("sync_branch output is missing.");
              return;
            }

            const head = `${owner}:${syncBranch}`;
            const base = "main";

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              head,
              base,
              state: "open",
            });

            if (prs.length > 0) {
              core.info(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            const title = `Sync upstream ${process.env.UPSTREAM_REPO}@${process.env.UPSTREAM_BRANCH}`;
            const body = [
              "Automated upstream sync detected conflicts.",
              "", 
              "This PR was generated by the nightly sync workflow and is labeled for Jules conflict resolution.",
            ].join("\n");

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              head: syncBranch,
              base,
              title,
              body,
            });

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels: ["auto-resolve", "upstream-sync"],
            });
